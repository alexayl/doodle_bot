# ------------------
#  Configurables
# ------------------
SIM_BOARD        := "qemu_x86"

ESP_BOARD        := "esp32s3_devkitc/esp32s3/procpu"
ESP_PORT         := "/dev/ttyUSB0"          # adjust

NRF_BOARD       := "nrf52840dk/nrf52840"

CMAKE_CACHE_ARGS := "-- -DCMAKE_EXPORT_COMPILE_COMMANDS=ON"

# ------------------
#  Helpers
# ------------------
_verify_workspace:
  test -d .west || { echo "ERROR: .west not found here. Ensure in firmware/ and README installation instructions have been followed."; exit 1; }

# ------------------
#  Sim (QEMU)
# ------------------

build-sim: _verify_workspace clean
  west build \
    -p always \
    -b {{SIM_BOARD}} \
    -d build \
    app \
    {{CMAKE_CACHE_ARGS}}

run-sim: build-sim
  west build -t run -d build

# ------------------
#  ESP32-S3
# ------------------

build-esp32: _verify_workspace clean
  west build \
    -p always \
    -b "{{ESP_BOARD}}" \
    -d build \
    app \
    {{CMAKE_CACHE_ARGS}} \
    -DEXTRA_DTC_OVERLAY_FILE="{{justfile_directory()}}/app/boards/esp32s3_devkitc.overlay"

flash-esp32:
  west flash --build-dir build

monitor-esp32:
  python -m serial.tools.miniterm "{{ESP_PORT}}" 115200

run-esp32: build-esp32 flash-esp32 monitor-esp32


# ------------------------------------
#  Nordic nRF52840 Development Kit
# ------------------------------------

build-nrf: _verify_workspace clean
  west build \
    -p always \
    -b "{{NRF_BOARD}}" \
    -d build \
    app \
    {{CMAKE_CACHE_ARGS}}


build-blinky:
  west build \
    -p always \
    -b "{{NRF_BOARD}}" \
    -d build \
    zephyr/samples/basic/blinky_pwm \
    {{CMAKE_CACHE_ARGS}} \
    -DEXTRA_DTC_OVERLAY_FILE="{{justfile_directory()}}/zephyr/samples/basic/blinky_pwm/boards/nrf52840dk_nrf52840.overlay"


# TODO: add overlay file for nRF52840

flash-nrf:
  west flash --build-dir build

monitor-nrf:
  python -m serial.tools.miniterm "/dev/ttyACM0" 115200


run-nrf: build-nrf flash-nrf monitor-nrf

# ------------------
# Tests
# -----------------
test: clean
  west build -b native_sim tests/state_machine
  west build -t run

# ------------------
#  Defaults
# ------------------

clean:
  rm -rf build
